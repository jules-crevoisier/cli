<?php

namespace App\Service;

use Aws\S3\S3Client;

class StorageService
{
    private S3Client $s3;
    private string $bucket;

    public function __construct()
    {
        $this->s3 = new S3Client([
            'endpoint' => $_ENV['S3_ENDPOINT'] ?? 'http://localhost:9000',
            'region' => 'us-east-1',
            'version' => 'latest',
            'credentials' => [
                'key' => $_ENV['S3_ACCESS_KEY'] ?? 'minioadmin',
                'secret' => $_ENV['S3_SECRET_KEY'] ?? 'minioadmin',
            ],
            'use_path_style_endpoint' => true,
        ]);
        $this->bucket = $_ENV['S3_BUCKET'] ?? '<%= projectName.replace(/-/g, '_') %>';
    }

    public function upload(string $key, string $body, string $contentType): string
    {
        $this->s3->putObject([
            'Bucket' => $this->bucket,
            'Key' => $key,
            'Body' => $body,
            'ContentType' => $contentType,
        ]);

        return sprintf('%s/%s/%s', $_ENV['S3_ENDPOINT'] ?? 'http://localhost:9000', $this->bucket, $key);
    }

    public function get(string $key): array
    {
        $result = $this->s3->getObject([
            'Bucket' => $this->bucket,
            'Key' => $key,
        ]);

        return [
            'body' => (string) $result['Body'],
            'contentType' => $result['ContentType'],
        ];
    }

    public function delete(string $key): void
    {
        $this->s3->deleteObject([
            'Bucket' => $this->bucket,
            'Key' => $key,
        ]);
    }
}
