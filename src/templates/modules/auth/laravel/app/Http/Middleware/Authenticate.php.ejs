<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
<% if (authStrategy === 'jwt') { %>
use Firebase\JWT\JWT;
use Firebase\JWT\Key;
<% } %>

class Authenticate
{
    public function handle(Request $request, Closure $next, string ...$roles)
    {
<% if (authStrategy === 'jwt') { %>
        $header = $request->header('Authorization');
        if (!$header || !str_starts_with($header, 'Bearer ')) {
            return response()->json(['error' => 'Authentication required'], 401);
        }

        try {
            $token = substr($header, 7);
            $payload = JWT::decode($token, new Key(config('app.jwt_secret', 'change-me'), 'HS256'));
            $request->merge(['auth_user' => (array) $payload]);

            if (!empty($roles) && !in_array($payload->role, $roles)) {
                return response()->json(['error' => 'Insufficient permissions'], 403);
            }
        } catch (\Exception $e) {
            return response()->json(['error' => 'Invalid or expired token'], 401);
        }
<% } else { %>
        $user = $request->session()->get('user');
        if (!$user) {
            return response()->json(['error' => 'Authentication required'], 401);
        }

        if (!empty($roles) && !in_array($user['role'] ?? '', $roles)) {
            return response()->json(['error' => 'Insufficient permissions'], 403);
        }
<% } %>

        return $next($request);
    }
}
